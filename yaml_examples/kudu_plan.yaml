#defaults:
#  "default name":
run_configurations:
  "cpp-reference":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 1
      "mem-per-cpu": 3700
    module_loads: []
    environment_variables: {}
    directory: "../0_cpp_versions/0_ref"
    build_commands:
      - "make -j 8"
    run_command: "./test_HPCCG"

  "cpp-openmp":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 16
      "mem-per-cpu": 3700
    module_loads: []
    environment_variables:
      "OMP_NUM_THREADS": 16
    directory: "../0_cpp_versions/1_openmp"
    build_commands:
      - "make -j 8"
    run_command: "./test_HPCCG"

  "cpp-mpi":
    sbatch_config:
      "nodes": 2
      "ntasks-per-node": 8
      "cpus-per-task": 1
      "mem-per-cpu": 3700
    module_loads:
      - "cs402-mpi"
    environment_variables: {}
    directory: "../0_cpp_versions/2_mpi"
    build_commands:
      - "make -j 8"
    run_command: "mpirun -n 2 ./test_HPCCG"

  "cpp-hybrid":
    sbatch_config:
      "nodes": 2
      "ntasks-per-node": 4
      "cpus-per-task": 2
      "mem-per-cpu": 3700
    module_loads:
      - "cs402-mpi"
    environment_variables:
      "OMP_NUM_THREADS": 2
    directory: "../0_cpp_versions/3_hybrid"
    build_commands:
      - "make -j 8"
    run_command: "mpirun -n 2 ./test_HPCCG"

  "rust-reference":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 1
      "mem-per-cpu": 3700
    module_loads: []
    environment_variables: {}
    directory: "../5_iterators"
    build_commands:
      - "cargo build --release"
    run_command: "cargo run --release"

  "rust-rayon":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 16
      "mem-per-cpu": 3700
    module_loads: []
    environment_variables:
      "OMP_NUM_THREADS": 16
    directory: "../6_parallel"
    build_commands:
      - "cargo build --release"
    run_command: "cargo run --release"

  "rust-mpi":
    sbatch_config:
      "nodes": 2
      "ntasks-per-node": 8
      "cpus-per-task": 1
      "mem-per-cpu": 3700
    module_loads:
      - "cs402-mpi"
    environment_variables: {}
    directory: "../7_mpi"
    build_commands:
      - "cargo build --release"
    run_command: "mpirun -n 2 ./target/release/hpccg-rs"

benches:
  "cpp-rust-comp":
    run_configurations:
      - "cpp-reference"
      # - "cpp-openmp"
      # - "cpp-mpi"
      # - "cpp-hybrid"
      # - "rust-reference"
      # - "rust-rayon"
      # - "rust-mpi"
    matrix:
      # args:
      #   - "100 100 100"
      #   - "200 200 200"
      # sbatch_config:
      #   - "nodes": 2
      #   - "nodes": 4
      #   - "nodes": 8
      run_command:
        - "foo"
        - "bar"
      [args, sbatch_config]:
        - ["100 100 100", {"mem-per-cpu": 1000}]
        - ["200 200 200", {"mem-per-cpu": 2000}]
    analysis:
      metrics:
        "name": "===== RUN (.*) ====="
        "nx": "nx: (\\d+)"
        "ny": "ny: (\\d+)"
        "nz": "nz: (\\d+)"
        "total time": "Time Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)[\\s\\S]*\nFLOPS Summary"
        "ddot time": "Time Summary:[\\s\\S]*DDOT\\s*: ([\\d\\.]+)[\\s\\S]*\nFLOPS Summary"
        "waxpby time": "Time Summary:[\\s\\S]*WAXPBY\\s*: ([\\d\\.]+)[\\s\\S]*\nFLOPS Summary"
        "sparsemv time": "Time Summary:[\\s\\S]*SPARSEMV\\s*: ([\\d\\.]+)[\\s\\S]*\nFLOPS Summary"
        "total flops": "FLOPS Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)[\\s\\S]*\nMFLOPS Summary"
        "ddot flops": "FLOPS Summary:[\\s\\S]*DDOT\\s*: ([\\d\\.]+)[\\s\\S]*\nMFLOPS Summary"
        "waxpby flops": "FLOPS Summary:[\\s\\S]*WAXPBY\\s*: ([\\d\\.]+)[\\s\\S]*\nMFLOPS Summary"
        "sparsemv flops": "FLOPS Summary:[\\s\\S]*SPARSEMV\\s*: ([\\d\\.]+)[\\s\\S]*\nMFLOPS Summary"
        "total mflops": "MFLOPS Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)"
        "ddot mflops": "MFLOPS Summary:[\\s\\S]*DDOT\\s*: ([\\d\\.]+)"
        "waxpby mflops": "MFLOPS Summary:[\\s\\S]*WAXPBY\\s*: ([\\d\\.]+)"
        "sparsemv mflops": "MFLOPS Summary:[\\s\\S]*SPARSEMV\\s*: ([\\d\\.]+)"
      plots:
        "nx": "total time"
